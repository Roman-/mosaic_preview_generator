<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cube Mosaic Previewer</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family:sans-serif; background:#f0f0f0; display:flex; flex-direction:column; min-height:100vh; }
    header{ padding:1rem 2rem; background:#111827; color:#f9fafb; text-align:center; font-size:1.5rem; }
    main{ flex:1; padding:2rem; display:grid; grid-template-columns:1fr 2fr; gap:2rem; }
    #original-wrapper,#preview-wrapper{ background:#fff; border-radius:0.75rem; box-shadow:0 4px 10px rgba(0,0,0,.1); padding:1rem; display:flex; flex-direction:column; align-items:center; }
    #preview-wrapper{ max-height:90vh; overflow:auto; }
    #original-image{ display: none; max-width:100%; image-rendering:pixelated; }
    #drop-message { color: #666; text-align: center; margin: 1rem 0; }
    #settings{ margin-top:1rem; width:100%; }
    .setting{ margin-bottom:1rem; display:flex; align-items:center; justify-content:space-between; gap:0.75rem; }
    .setting label{ flex:1; font-size:.9rem; }
    .setting input[type="range"]{ flex:2; }
    #preset-buttons button{ flex:1; }
    canvas{ max-width:100%; height:auto; border-radius:0.5rem; }
    footer{ text-align:center; padding:.5rem; background:#e5e7eb; font-size:.8rem; }
    #original-wrapper { cursor: pointer; }
    #file-input { display: none; }
    #original-wrapper.dragover { border: 2px dashed #888; }
  </style>
</head>
<body>
  <header>Cube Mosaic Previewer</header>
  <main>
    <section id="original-wrapper">
      <h2>Miniature</h2>
      <p id="drop-message">Drag and drop an image here, or click to select</p>
      <input type="file" accept="image/png" id="file-input" />
      <img id="original-image" alt="Miniature preview" />
    </section>

    <section id="preview-wrapper">
      <h2>Preview</h2>
      <canvas id="preview-canvas"></canvas>
      <div id="settings">
        <h3>Settings</h3>
        <div class="setting" id="preset-buttons">
          <button id="preset-zero">Reset to zero</button>
          <button id="preset-photo">Photorealistic</button>
        </div>
        <div class="setting"><label for="plastic-color">Plastic color</label><input type="color" id="plastic-color" value="#191919"></div>
        <div class="setting"><label for="frame-color">Frame color</label><input type="color" id="frame-color" value="#000000"></div>
        <div class="setting"><label for="frame-size">Frame size (<span id="frame-size-val">8</span> px)</label><input type="range" id="frame-size" min="0" max="30" value="8"></div>
        <div class="setting"><label for="border-ratio">Border thickness (<span id="border-ratio-val">0.15</span>)</label><input type="range" id="border-ratio" min="0" max="1" step="0.01" value="0.15"></div>
        <div class="setting"><label for="brightness-shift">Brightness shift (<span id="brightness-shift-val">10</span>%)</label><input type="range" id="brightness-shift" min="0" max="60" value="10"></div>
        <div class="setting"><label for="displacement-ratio">Displacement (<span id="displacement-ratio-val">0.05</span>)</label><input type="range" id="displacement-ratio" min="0" max="1" step="0.01" value="0.05"></div>
        <div class="setting"><label for="roundness-ratio">Corner roundness (<span id="roundness-ratio-val">0</span>)</label><input type="range" id="roundness-ratio" min="0" max="1" step="0.01" value="0"></div>
        <div class="setting"><label for="output-height">Image height (px)</label><input type="number" id="output-height" value="2000" min="1"></div>
        <div class="setting" id="download-wrapper" style="justify-content:flex-start;gap:0.75rem;">
          <button id="download-btn" style="flex:1;width:100%;padding:0.5rem 1rem;font-size:1rem;">Download</button>
          <span id="export-dimensions"></span>
        </div>
      </div>
    </section>
  </main>
  <footer>&copy; 2025 Cube Mosaic Previewer</footer>

  <script>
    // ==== Elements ====
    const fileInput = document.getElementById('file-input');
    const originalImg = document.getElementById('original-image');
    const dropMessage = document.getElementById('drop-message');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');

    const plasticColorInput = document.getElementById('plastic-color');
    const frameColorInput = document.getElementById('frame-color');
    const frameSizeInput = document.getElementById('frame-size');
    const borderRatioInput = document.getElementById('border-ratio');
    const brightnessShiftInput = document.getElementById('brightness-shift');
    const displacementRatioInput = document.getElementById('displacement-ratio');
    const roundnessRatioInput = document.getElementById('roundness-ratio');
    const outputHeightInput = document.getElementById('output-height');
    const downloadBtn = document.getElementById('download-btn');
    const exportDimensions = document.getElementById('export-dimensions');
    const presetZeroBtn = document.getElementById('preset-zero');
    const presetPhotoBtn = document.getElementById('preset-photo');

    // Span outputs
    const frameSizeVal = document.getElementById('frame-size-val');
    const borderRatioVal = document.getElementById('border-ratio-val');
    const brightnessShiftVal = document.getElementById('brightness-shift-val');
    const displacementRatioVal = document.getElementById('displacement-ratio-val');
    const roundnessRatioVal = document.getElementById('roundness-ratio-val');

    // Fixed params
    const tileSize = 20;

    const PRESETS = {
      zero: {
        plasticColor: '#000000',
        frameColor: '#000000',
        frameSize: 0,
        borderRatio: 0,
        brightnessShift: 0,
        displacementRatio: 0,
        roundnessRatio: 0
      },
      photo: {
        plasticColor: '#191919',
        frameColor: '#000000',
        frameSize: 8,
        borderRatio: 0.15,
        brightnessShift: 10,
        displacementRatio: 0.05,
        roundnessRatio: 0
      }
    };

    // === Helpers ===
    function adjustBrightness(rgba, shiftPercent){
      if(!shiftPercent) return `rgba(${rgba[0]},${rgba[1]},${rgba[2]},${rgba[3]/255})`;
      const factor = 1 + (Math.random()*2*shiftPercent - shiftPercent)/100;
      return `rgba(${[0,1,2].map(i=>Math.min(255,Math.max(0,Math.round(rgba[i]*factor)))).join(',')},${rgba[3]/255})`;
    }

    function drawRounded(ctx,x,y,w,h,r){
      if(r<=0){ ctx.fillRect(x,y,w,h); return; }
      const maxR = Math.min(w,h)/2;
      if(r>=maxR-0.01){ // draw circle
        const cx = x + w/2, cy = y + h/2;
        ctx.beginPath(); ctx.arc(cx,cy,maxR,0,Math.PI*2); ctx.fill();
        return;
      }
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.lineTo(x+w-r,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r);
      ctx.lineTo(x+w,y+h-r);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
      ctx.lineTo(x+r,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r);
      ctx.lineTo(x,y+r);
      ctx.quadraticCurveTo(x,y,x+r,y);
      ctx.closePath();
      ctx.fill();
    }

    function drawMosaic(img){
      if(!img.complete||!img.naturalWidth) return;
      const w = img.width, h = img.height;
      const frameSize = +frameSizeInput.value;
      const frameColor= frameColorInput.value;
      const plasticColor = plasticColorInput.value;
      const borderRatio = +borderRatioInput.value;
      const brightnessShift=+brightnessShiftInput.value;
      const dispRatio = +displacementRatioInput.value;
      const roundRatio = +roundnessRatioInput.value;

      const border = tileSize*borderRatio*0.5;
      const squareSize = Math.max(0,tileSize-border*2);
      const dispAmp = tileSize*0.5*dispRatio;
      const radius = squareSize*0.5*roundRatio; // 0 -> 0, 1 -> sqSize/2 (circle)

      canvas.width = w*tileSize + frameSize*2;
      canvas.height= h*tileSize + frameSize*2;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=plasticColor;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillRect(frameSize,frameSize,w*tileSize,h*tileSize);

      const off=document.createElement('canvas'); off.width=w; off.height=h;
      off.getContext('2d').drawImage(img,0,0);
      const data=off.getContext('2d').getImageData(0,0,w,h).data;

      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          if(!squareSize) continue;
          const idx=(y*w+x)*4;
          const rgba=[data[idx],data[idx+1],data[idx+2],data[idx+3]];
          const fill=adjustBrightness(rgba,brightnessShift);
          const dx=(Math.random()*2-1)*dispAmp;
          const dy=(Math.random()*2-1)*dispAmp;
          const sx=frameSize + x*tileSize + border + dx;
          const sy=frameSize + y*tileSize + border + dy;
          ctx.fillStyle=fill;
          drawRounded(ctx,sx,sy,squareSize,squareSize,radius);
        }
      }

      if(frameSize){
        ctx.lineWidth=frameSize;
        ctx.strokeStyle=frameColor;
        ctx.strokeRect(frameSize/2,frameSize/2,canvas.width-frameSize,canvas.height-frameSize);
      }
    }

    function refresh(){
      drawMosaic(originalImg);
      updateDimensions();
    }

    function updateSliderDisplays(){
      frameSizeVal.textContent=frameSizeInput.value;
      borderRatioVal.textContent=borderRatioInput.value;
      brightnessShiftVal.textContent=brightnessShiftInput.value;
      displacementRatioVal.textContent=displacementRatioInput.value;
      roundnessRatioVal.textContent=roundnessRatioInput.value;
    }

    function updateDimensions(){
      const h=+outputHeightInput.value||0;
      const ratio=canvas.width&&canvas.height?canvas.width/canvas.height:1;
      const w=Math.round(h*ratio);
      exportDimensions.textContent=`${w} x ${h}px`;
    }

    function applyPreset(p){
      plasticColorInput.value=p.plasticColor;
      frameColorInput.value=p.frameColor;
      frameSizeInput.value=p.frameSize;
      borderRatioInput.value=p.borderRatio;
      brightnessShiftInput.value=p.brightnessShift;
      displacementRatioInput.value=p.displacementRatio;
      roundnessRatioInput.value=p.roundnessRatio;
      updateSliderDisplays();
      refresh();
    }

    // Slider linkage
    [
      {el:frameSizeInput,span:frameSizeVal},
      {el:borderRatioInput,span:borderRatioVal},
      {el:brightnessShiftInput,span:brightnessShiftVal},
      {el:displacementRatioInput,span:displacementRatioVal},
      {el:roundnessRatioInput,span:roundnessRatioVal}
    ].forEach(({el,span})=>{
      const upd=()=>span.textContent=el.value;
      el.addEventListener('input',()=>{upd();refresh();});
      upd();
    });

    [plasticColorInput,frameColorInput].forEach(el=>el.addEventListener('input',refresh));
    outputHeightInput.addEventListener('input', updateDimensions);
    downloadBtn.addEventListener('click', () => {
      const h = +outputHeightInput.value || canvas.height;
      const ratio = canvas.width && canvas.height ? canvas.width / canvas.height : 1;
      const w = Math.round(h * ratio);
      const off = document.createElement('canvas');
      off.width = w;
      off.height = h;
      off.getContext('2d').drawImage(canvas, 0, 0, w, h);
      off.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mosaic.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });
    presetZeroBtn.addEventListener('click', () => applyPreset(PRESETS.zero));
    presetPhotoBtn.addEventListener('click', () => applyPreset(PRESETS.photo));

    // Handle file selection (via input or drop)
    function handleFile(file) {
      if (!file) return;
      // hide instruction message and reset image visibility
      dropMessage.style.display = 'none';
      originalImg.style.display = 'none';
      const url = URL.createObjectURL(file);
      originalImg.onload = () => {
        refresh();
        URL.revokeObjectURL(url);
        originalImg.style.display = 'block';
      };
      originalImg.src = url;
    }

    fileInput.addEventListener('change', e => {
      handleFile(e.target.files[0]);
    });

    const originalWrapper = document.getElementById('original-wrapper');
    // Open file dialog on click
    originalWrapper.addEventListener('click', () => fileInput.click());
    // Drag-and-drop handlers
    ['dragenter', 'dragover'].forEach(event => {
      originalWrapper.addEventListener(event, e => {
        e.preventDefault();
        originalWrapper.classList.add('dragover');
      });
    });
    ['dragleave', 'drop'].forEach(event => {
      originalWrapper.addEventListener(event, e => {
        e.preventDefault();
        originalWrapper.classList.remove('dragover');
      });
    });
    originalWrapper.addEventListener('drop', e => {
      handleFile(e.dataTransfer.files[0]);
    });

    updateDimensions();
  </script>
</body>
</html>
