<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cube Mosaic Previewer</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family:sans-serif; background:#f0f0f0; display:flex; flex-direction:column; min-height:100vh; }
    header{ padding:1rem 2rem; background:#111827; color:#f9fafb; text-align:center; font-size:1.5rem; }
    main{ flex:1; padding:2rem; display:grid; grid-template-columns:1fr 2fr; gap:2rem; }
    #original-wrapper,#preview-wrapper{ background:#fff; border-radius:0.75rem; box-shadow:0 4px 10px rgba(0,0,0,.1); padding:1rem; display:flex; flex-direction:column; align-items:center; }
    #original-image{ max-width:100%; image-rendering:pixelated; }
    #settings{ margin-top:1rem; width:100%; }
    .setting{ margin-bottom:1rem; display:flex; align-items:center; justify-content:space-between; gap:0.75rem; }
    .setting label{ flex:1; font-size:.9rem; }
    .setting input[type="range"]{ flex:2; }
    canvas{ max-width:100%; height:auto; border-radius:0.5rem; }
    footer{ text-align:center; padding:.5rem; background:#e5e7eb; font-size:.8rem; }
  </style>
</head>
<body>
  <header>Cube Mosaic Previewer</header>
  <main>
    <section id="original-wrapper">
      <h2>Miniature</h2>
      <input type="file" accept="image/png" id="file-input" />
      <img id="original-image" alt="Miniature preview" />
    </section>

    <section id="preview-wrapper">
      <h2>Preview</h2>
      <canvas id="preview-canvas"></canvas>
      <div id="settings">
        <h3>Settings</h3>
        <div class="setting"><label for="plastic-color">Plastic color</label><input type="color" id="plastic-color" value="#191919"></div>
        <div class="setting"><label for="frame-color">Frame color</label><input type="color" id="frame-color" value="#000000"></div>
        <div class="setting"><label for="frame-size">Frame size (<span id="frame-size-val">8</span> px)</label><input type="range" id="frame-size" min="0" max="30" value="8"></div>
        <div class="setting"><label for="border-ratio">Border thickness (<span id="border-ratio-val">0.15</span>)</label><input type="range" id="border-ratio" min="0" max="1" step="0.01" value="0.15"></div>
        <div class="setting"><label for="brightness-shift">Brightness shift (<span id="brightness-shift-val">10</span>%)</label><input type="range" id="brightness-shift" min="0" max="60" value="10"></div>
        <div class="setting"><label for="displacement-ratio">Displacement (<span id="displacement-ratio-val">0.05</span>)</label><input type="range" id="displacement-ratio" min="0" max="1" step="0.01" value="0.05"></div>
        <div class="setting"><label for="roundness-ratio">Corner roundness (<span id="roundness-ratio-val">0</span>)</label><input type="range" id="roundness-ratio" min="0" max="1" step="0.01" value="0"></div>
      </div>
    </section>
  </main>
  <footer>&copy; 2025 Cube Mosaic Previewer</footer>

  <script>
    // ==== Elements ====
    const fileInput = document.getElementById('file-input');
    const originalImg = document.getElementById('original-image');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');

    const plasticColorInput = document.getElementById('plastic-color');
    const frameColorInput = document.getElementById('frame-color');
    const frameSizeInput = document.getElementById('frame-size');
    const borderRatioInput = document.getElementById('border-ratio');
    const brightnessShiftInput = document.getElementById('brightness-shift');
    const displacementRatioInput = document.getElementById('displacement-ratio');
    const roundnessRatioInput = document.getElementById('roundness-ratio');

    // Span outputs
    const frameSizeVal = document.getElementById('frame-size-val');
    const borderRatioVal = document.getElementById('border-ratio-val');
    const brightnessShiftVal = document.getElementById('brightness-shift-val');
    const displacementRatioVal = document.getElementById('displacement-ratio-val');
    const roundnessRatioVal = document.getElementById('roundness-ratio-val');

    // Fixed params
    const tileSize = 20;

    // === Helpers ===
    function adjustBrightness(rgba, shiftPercent){
      if(!shiftPercent) return `rgba(${rgba[0]},${rgba[1]},${rgba[2]},${rgba[3]/255})`;
      const factor = 1 + (Math.random()*2*shiftPercent - shiftPercent)/100;
      return `rgba(${[0,1,2].map(i=>Math.min(255,Math.max(0,Math.round(rgba[i]*factor)))).join(',')},${rgba[3]/255})`;
    }

    function drawRounded(ctx,x,y,w,h,r){
      if(r<=0){ ctx.fillRect(x,y,w,h); return; }
      const maxR = Math.min(w,h)/2;
      if(r>=maxR-0.01){ // draw circle
        const cx = x + w/2, cy = y + h/2;
        ctx.beginPath(); ctx.arc(cx,cy,maxR,0,Math.PI*2); ctx.fill();
        return;
      }
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.lineTo(x+w-r,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r);
      ctx.lineTo(x+w,y+h-r);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
      ctx.lineTo(x+r,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r);
      ctx.lineTo(x,y+r);
      ctx.quadraticCurveTo(x,y,x+r,y);
      ctx.closePath();
      ctx.fill();
    }

    function drawMosaic(img){
      if(!img.complete||!img.naturalWidth) return;
      const w = img.width, h = img.height;
      const frameSize = +frameSizeInput.value;
      const frameColor= frameColorInput.value;
      const plasticColor = plasticColorInput.value;
      const borderRatio = +borderRatioInput.value;
      const brightnessShift=+brightnessShiftInput.value;
      const dispRatio = +displacementRatioInput.value;
      const roundRatio = +roundnessRatioInput.value;

      const border = tileSize*borderRatio*0.5;
      const squareSize = Math.max(0,tileSize-border*2);
      const dispAmp = tileSize*0.5*dispRatio;
      const radius = squareSize*0.5*roundRatio; // 0 -> 0, 1 -> sqSize/2 (circle)

      canvas.width = w*tileSize + frameSize*2;
      canvas.height= h*tileSize + frameSize*2;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=plasticColor;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillRect(frameSize,frameSize,w*tileSize,h*tileSize);

      const off=document.createElement('canvas'); off.width=w; off.height=h;
      off.getContext('2d').drawImage(img,0,0);
      const data=off.getContext('2d').getImageData(0,0,w,h).data;

      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          if(!squareSize) continue;
          const idx=(y*w+x)*4;
          const rgba=[data[idx],data[idx+1],data[idx+2],data[idx+3]];
          const fill=adjustBrightness(rgba,brightnessShift);
          const dx=(Math.random()*2-1)*dispAmp;
          const dy=(Math.random()*2-1)*dispAmp;
          const sx=frameSize + x*tileSize + border + dx;
          const sy=frameSize + y*tileSize + border + dy;
          ctx.fillStyle=fill;
          drawRounded(ctx,sx,sy,squareSize,squareSize,radius);
        }
      }

      if(frameSize){
        ctx.lineWidth=frameSize;
        ctx.strokeStyle=frameColor;
        ctx.strokeRect(frameSize/2,frameSize/2,canvas.width-frameSize,canvas.height-frameSize);
      }
    }

    function refresh(){ drawMosaic(originalImg); }

    // Slider linkage
    [
      {el:frameSizeInput,span:frameSizeVal},
      {el:borderRatioInput,span:borderRatioVal},
      {el:brightnessShiftInput,span:brightnessShiftVal},
      {el:displacementRatioInput,span:displacementRatioVal},
      {el:roundnessRatioInput,span:roundnessRatioVal}
    ].forEach(({el,span})=>{
      const upd=()=>span.textContent=el.value;
      el.addEventListener('input',()=>{upd();refresh();});
      upd();
    });

    [plasticColorInput,frameColorInput].forEach(el=>el.addEventListener('input',refresh));

    fileInput.addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const url=URL.createObjectURL(f);
      originalImg.src=url;
      originalImg.onload=()=>{refresh(); URL.revokeObjectURL(url);};
    });
  </script>
</body>
</html>
